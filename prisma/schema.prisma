generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "sqlserver"
}

// ----------------- API KEYS -----------------
model ApiKey {
  id          String   @id @default(uuid())
  tenantId    String   @map("tenant_id")
  name        String
  keyHash     String   @unique @map("key_hash")
  isActive    Boolean  @default(true) @map("is_active")
  permissions String   @default("{}")
  
  rateLimit   Int      @default(100) @map("rate_limit")
  windowMs    Int      @default(900000) @map("window_ms")
    
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  lastUsedAt  DateTime? @map("last_used_at")
  
  @@index([isActive])
  @@map("api_keys")
}

// ----------------- ROLES E PERMISSIONS -----------------
model Role {
  id          Int          @id @default(autoincrement())
  name        String       @unique
  description String?

  permissions Permission[] @relation("RolePermissions")
  users       UserRole[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  RolePermission RolePermission[]
}

model Permission {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  description String?
  roles       Role[]    @relation("RolePermissions")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  RolePermission RolePermission[]
}

// Tabela de liga√ß√£o Usu√°rio <-> Role
model UserRole {
  user   User @relation(fields: [userId], references: [id])
  userId Int
  role   Role @relation(fields: [roleId], references: [id])
  roleId Int

  @@id([userId, roleId])
}

// Tabela de liga√ß√£o Role <-> Permission
model RolePermission {
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       Int
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId Int

  @@id([roleId, permissionId])
}

// ----------------- USU√ÅRIOS -----------------
model User {
  id        Int       @id @default(autoincrement())
  nome      String
  email     String    @unique
  senhaHash String
  ativo     Boolean   @default(true)

  roles       UserRole[]
  consultor   Consultor? @relation("UserConsultor")
  
  autorizacoesTecnico AutorizacaoLegal[] @relation("UserToAutorizacaoLegal") 
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Consultor {
  id     Int    @id @default(autoincrement())
  nome   String

  user   User?  @relation("UserConsultor", fields: [userId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  userId Int?   @unique

  titulares  Titular[]
  comissoes  Comissao[] @relation("ConsultorComissoes")
}

// ----------------- TITULAR -----------------
model Titular {
  id              Int              @id @default(autoincrement())
  nome            String
  email           String           @unique
  telefone        String?
  dataNascimento  DateTime
  statusPlano     String
  dataContratacao DateTime
  
  cep       String?
  uf        String?
  cidade    String?
  cpf       String?
  bairro    String?
  logradouro String?
  complemento String?
  numero      String?

  dependentes     Dependente[]
  corresponsaveis Corresponsavel[]
  pagamentos      Pagamento[]
  documentos      Documento[]
  comissoes       Comissao[] @relation("TitularComissoes")
  contasReceber   ContaReceber[]
  orcamentos      Orcamento[]
  recibos         Recibo[]
  assinaturas     AssinaturaDigital[]

  planoId        Int?
  plano          Plano?      @relation(fields: [planoId], references: [id]) // üîπ Rela√ß√£o adicionada

  vendedor        Consultor? @relation(fields: [vendedorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  vendedorId      Int?
}

// ----------------- DEPENDENTES -----------------
model Dependente {
  id             Int      @id @default(autoincrement())
  titular        Titular  @relation(fields: [titularId], references: [id])
  titularId      Int
  nome           String
  dataNascimento DateTime
  tipoDependente String
}

// ----------------- CORRESPONS√ÅVEIS -----------------
model Corresponsavel {
  id             Int      @id @default(autoincrement())
  titular        Titular  @relation(fields: [titularId], references: [id])
  titularId      Int
  nome           String
  email          String
  telefone       String?
  relacionamento String

  autorizacoesLegais AutorizacaoLegal[] @relation("CorresponsavelToAutorizacaoLegal")
}

model AssinaturaDigital {
  id        Int      @id @default(autoincrement())
  titular   Titular  @relation(fields: [titularId], references: [id], onDelete: Cascade)
  titularId Int
  tipo      String
  arquivoId String
  arquivoUrl String
  filename  String
  mimetype  String?
  size      Int?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([titularId, tipo])
}

// ----------------- PLANOS -----------------
model Plano {
  id                           Int     @id @default(autoincrement())
  nome                         String
  valorMensal                  Float
  idadeMaxima                  Int?
  coberturaMaxima              Int
  carenciaDias                 Int
  vigenciaMeses                Int
  ativo                        Boolean @default(true)
  totalClientes                Int     @default(0)
  receitaMensal                Float   @default(0)
  assistenciaFuneral           Int
  auxilioCemiterio             Int?
  taxaInclusaCemiterioPublico  Boolean @default(false)

  beneficiarios                PlanoBeneficiario[]
  coberturas                   PlanoCobertura[]
  beneficios                   PlanoBeneficio[]
  tiposBeneficiarios           PlanoBeneficiarioTipo[]
  titulares                    Titular[]
}

// ----------------- BENEFICI√ÅRIOS -----------------
model PlanoBeneficiario {
  id       Int    @id @default(autoincrement())
  plano    Plano  @relation(fields: [planoId], references: [id])
  planoId  Int
  nome     String
}

// ----------------- COBERTURAS -----------------
model PlanoCobertura {
  id       Int    @id @default(autoincrement())
  plano    Plano  @relation(fields: [planoId], references: [id])
  planoId  Int
  tipo     String // "servicosPadrao", "coberturaTranslado", "servicosEspecificos"
  descricao String
}

// ----------------- TIPOS DE BENEFICI√ÅRIO -----------------
model BeneficiarioTipo {
  id       Int     @id @default(autoincrement())
  nome     String
  idadeMax Int?
  planos   PlanoBeneficiarioTipo[]
}

model PlanoBeneficiarioTipo {
  plano            Plano            @relation(fields: [planoId], references: [id])
  planoId          Int
  beneficiarioTipo BeneficiarioTipo @relation(fields: [beneficiarioTipoId], references: [id])
  beneficiarioTipoId Int

  @@id([planoId, beneficiarioTipoId])
}

// ----------------- BENEF√çCIOS -----------------
model Beneficio {
  id        Int               @id @default(autoincrement())
  nome      String
  tipo      String
  descricao String
  valor     Float?
  validade  Int?
  planos    PlanoBeneficio[]

  @@map("Beneficio")
}

model PlanoBeneficio {
  // Se a tabela real tiver outro nome (ex.: "Plano_Beneficio"), mapeie:
  @@map("Plano_Beneficio")

  // Mapeie as colunas reais se forem, por exemplo, "plano_id" e "beneficio_id"
  planoId      Int        @map("plano_id")
  beneficioId  Int        @map("beneficio_id")

  plano        Plano      @relation(fields: [planoId], references: [id])
  beneficio    Beneficio  @relation(fields: [beneficioId], references: [id])

  @@id([planoId, beneficioId])
}

// ----------------- PAGAMENTOS -----------------
model Pagamento {
  id              Int      @id @default(autoincrement())
  titular         Titular  @relation(fields: [titularId], references: [id])
  titularId       Int
  valor           Float
  dataPagamento   DateTime
  status          String
  metodoPagamento String
}

// ----------------- COMISS√ïES -----------------
model Comissao {
  id              Int       @id @default(autoincrement())
  vendedor        Consultor  @relation("ConsultorComissoes", fields: [vendedorId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  vendedorId      Int
  titular         Titular   @relation("TitularComissoes", fields: [titularId], references: [id], onDelete: NoAction, onUpdate: NoAction)
  titularId       Int
  valor           Float
  dataGeracao     DateTime
  statusPagamento String
}

// ----------------- DOCUMENTOS -----------------
model Documento {
  id            Int      @id @default(autoincrement())
  titular       Titular  @relation(fields: [titularId], references: [id])
  titularId     Int
  tipoDocumento String
  arquivoUrl    String
  dataUpload    DateTime
}

// ----------------- LAYOUT CONFIG -----------------
model LayoutConfig {
  id                Int       @id @default(autoincrement())
  tenantId          String
  nomeTema          String    @default("Padr√£o")

  corPrimaria        String    @default("#007bff")
  corSecundaria      String    @default("#6c757d")
  corFundo           String    @default("#ffffff")
  corTexto           String    @default("#000000")
  corBotaoPrimario   String    @default("#007bff")
  corBotaoSecundario String    @default("#6c757d")
  corLink            String    @default("#007bff")

  fontePrimaria      String    @default("Arial, sans-serif")
  fonteSecundaria    String?
  tamanhoFonteBase   Int       @default(14)
  tamanhoFonteTitulo Int       @default(18)

  logoUrl            String?
  faviconUrl         String?
  backgroundUrl      String?

  bordaRadius        Int?      @default(4)
  sombraPadrao       String?   @default("0px 2px 4px rgba(0,0,0,0.1)")

  ativo              Boolean   @default(true)
  criadoEm           DateTime  @default(now())
  atualizadoEm       DateTime  @updatedAt
}

// ----------------- FINANCEIRO -----------------

model Imposto {
  id        Int      @id @default(autoincrement())
  nome      String
  aliquota  Float     // percentual (%)
  tipo      String    // ISS, ICMS, etc.
  ativo     Boolean   @default(true)
}

model TaxaCartao {
  id          Int      @id @default(autoincrement())
  bandeira    String
  percentual  Float
  fixo        Float?   // taxa fixa
  ativo       Boolean  @default(true)
}

model ContaPagar {
  id           Int      @id @default(autoincrement())
  descricao    String
  valor        Float
  vencimento   DateTime
  dataPagamento DateTime?
  status       String   // "Pendente", "Pago", "Atrasado"
  fornecedor   String?
}

model ContaReceber {
  id           Int      @id @default(autoincrement())
  descricao    String
  valor        Float
  vencimento   DateTime
  dataRecebimento DateTime?
  status       String
  clienteId    Int?
  cliente      Titular? @relation(fields: [clienteId], references: [id])
}

model BancoFinanceiro {
  id        Int      @id @default(autoincrement())
  nome      String
  agencia   String?
  conta     String?
  saldo     Float    @default(0)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TipoContabilFinanceiro {
  id        Int      @id @default(autoincrement())
  descricao String
  natureza  String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FormaPagamentoFinanceira {
  id        Int      @id @default(autoincrement())
  nome      String
  prazo     String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model CentroResultadoFinanceiro {
  id        Int      @id @default(autoincrement())
  nome      String
  descricao String?
  orcamento Float    @default(0)
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Orcamento {
  id          Int       @id @default(autoincrement())
  cliente     Titular?  @relation(fields: [clienteId], references: [id])
  clienteId   Int?
  valorTotal  Float
  dataEmissao DateTime  @default(now())
  status      String    // "Aberto", "Aprovado", "Rejeitado"
  observacao  String?
}

model Recibo {
  id          Int       @id @default(autoincrement())
  numero      String    @unique
  cliente     Titular?  @relation(fields: [clienteId], references: [id])
  clienteId   Int?
  valor       Float
  dataEmissao DateTime  @default(now())
  descricao   String?
}

model NotaFiscal {
  id          Int       @id @default(autoincrement())
  numero      String    @unique
  valorTotal  Float
  dataEmissao DateTime  @default(now())
  status      String
  chaveAcesso String?
}

// ----------------- ESTOQUE E SERVI√áOS -----------------

model Produto {
  id            Int      @id @default(autoincrement())
  nome          String
  descricao     String?
  quantidade    Int       @default(0)
  precoUnitario Float
  tipo          String    // urna, coroa, ornamento, etc.
  movimentos MovimentoEstoque[]
  itensServico ServicoItem[]
  ativo         Boolean   @default(true)
}

model MovimentoEstoque {
  id           Int      @id @default(autoincrement())
  produto      Produto  @relation(fields: [produtoId], references: [id])
  produtoId    Int
  tipo         String   // "Entrada" ou "Sa√≠da"
  quantidade   Int
  dataMovimento DateTime @default(now())
  observacao   String?
}

model Servico {
  id           Int      @id @default(autoincrement())
  nome         String
  descricao    String?
  custoBase    Float
  precoVenda   Float
  ativo        Boolean   @default(true)

  itens ServicoItem[] 
}

model ServicoItem {
  id          Int      @id @default(autoincrement())
  servico     Servico  @relation(fields: [servicoId], references: [id])
  servicoId   Int
  produto     Produto? @relation(fields: [produtoId], references: [id])
  produtoId   Int?
  quantidade  Int       @default(1)
  custo       Float?
}

// ----------------- AUTORIZA√á√ïES E FALECIDOS -----------------

model Falecido {
  id            Int                 @id @default(autoincrement())
  nome          String
  dataFalecimento DateTime?
  autorizacoes  AutorizacaoLegal[]  @relation("FalecidoToAutorizacaoLegal")

  Sepultamento Sepultamento[]
}

model AutorizacaoLegal {
  id             Int       @id @default(autoincrement())
  falecido       Falecido  @relation("FalecidoToAutorizacaoLegal", fields: [falecidoId], references: [id], onDelete: NoAction, onUpdate: Cascade)
  falecidoId     Int
  responsavel    Corresponsavel? @relation("CorresponsavelToAutorizacaoLegal", fields: [responsavelId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  responsavelId  Int?
  tecnico        User?     @relation("UserToAutorizacaoLegal", fields: [tecnicoId], references: [id], onDelete: SetNull, onUpdate: Cascade)
  tecnicoId      Int?
  tipo           String
  dataAssinatura DateTime  @default(now())
  assinaturaUrl  String?
}

// ----------------- FROTA -----------------

model Veiculo {
  id          Int      @id @default(autoincrement())
  placa       String   @unique
  modelo      String
  ano         Int
  tipo        String   // carro funer√°rio, van, etc.
  ativo       Boolean  @default(true)
  quilometragemAtual Int?

  manutencoes    Manutencao[]
  abastecimentos Abastecimento[]
}

model Motorista {
  id          Int      @id @default(autoincrement())
  nome        String
  cpf         String?
  cnh         String?
  telefone    String?
  ativo       Boolean  @default(true)
  
  abastecimentos Abastecimento[]
}

model Manutencao {
  id          Int       @id @default(autoincrement())
  veiculo     Veiculo   @relation(fields: [veiculoId], references: [id])
  veiculoId   Int
  data        DateTime
  descricao   String
  custo       Float
}

model Abastecimento {
  id          Int       @id @default(autoincrement())
  veiculo     Veiculo   @relation(fields: [veiculoId], references: [id])
  veiculoId   Int
  motorista   Motorista? @relation(fields: [motoristaId], references: [id])
  motoristaId Int?
  data        DateTime
  litros      Float
  valorTotal  Float
}

// ----------------- CEMIT√âRIOS -----------------

model Cemiterio {
  id          Int      @id @default(autoincrement())
  nome        String
  endereco    String
  cidade      String
  bairro      String?
  observacoes String?
  ativo       Boolean   @default(true)

  sepultamentos Sepultamento[]
}

model TipoSepultamento {
  id          Int      @id @default(autoincrement())
  nome        String
  descricao   String?
  valor       Float?

  sepultamentos Sepultamento[]
}

model Sepultamento {
  id              Int          @id @default(autoincrement())
  falecido        Falecido     @relation(fields: [falecidoId], references: [id])
  falecidoId      Int
  cemiterio       Cemiterio    @relation(fields: [cemiterioId], references: [id])
  cemiterioId     Int
  tipo            TipoSepultamento @relation(fields: [tipoId], references: [id])
  tipoId          Int
  dataSepultamento DateTime
  observacoes     String?
}

model BusinessRules {
  tenantId                   String  @id

  // -------------------- Fluxo de Notifica√ß√µes --------------------
  diasAvisoVencimento        Int?    // dias antes do vencimento
  diasAvisoPendencia         Int?    // dias ap√≥s vencimento para aviso de pend√™ncia
  repeticaoPendenciaDias     Int?    // repeti√ß√£o do aviso de pend√™ncia
  diasSuspensaoPreventiva    Int?    // alerta preventivo antes da suspens√£o
  diasSuspensao              Int?    // dia da suspens√£o
  diasPosSuspensao           Int?    // p√≥s-suspens√£o
  avisoReajusteAnual         Boolean? // enviar aviso de reajuste
  diasAntesReajusteAnual     Int?    // aviso antecipado de reajuste
  avisoRenovacaoAutomatica   Boolean? // aviso de renova√ß√£o autom√°tica
  diasAntesRenovacao         Int?    // aviso X dias antes da renova√ß√£o

  // -------------------- Estoque --------------------
  permitirEstoqueNegativo    Boolean?
  notificarEstoqueBaixo      Boolean?
  quantidadeMinimaEstoque    Int?    // limiar para notifica√ß√£o de estoque baixo
  notificarServicoPendente   Boolean? // se servi√ßo composto depende de materiais

  // -------------------- Planos e Benefici√°rios --------------------
  idadeMaximaDependente      Int?
  limiteBeneficiarios        Int?
  maximoBeneficiariosPorTipo Int?    // limite por tipo de benefici√°rio

  // -------------------- Frota --------------------
  quilometragemMaxVeiculo    Int?
  notificarManutencao        Boolean?
  intervaloManutencaoKm      Int?    // km entre manuten√ß√µes preventivas
  intervaloManutencaoDias    Int?    // dias entre manuten√ß√µes preventivas

  // -------------------- Cemit√©rios --------------------
  diasAntesAvisoRenovacaoSepultamento Int? // aviso antecipado de renova√ß√£o de uso
  limiteTempoUsoSepultamento          Int? // limite m√°ximo de tempo permitido

  // -------------------- Financeiro --------------------
  notificarTaxaVencida       Boolean? // aviso de taxa vencida
  tipoAvisoTaxaVencida       String?  // detalhamento do tipo de aviso

  ativo                      Boolean? @default(true)
  criadoEm                   DateTime @default(now())
  atualizadoEm               DateTime @updatedAt
}
